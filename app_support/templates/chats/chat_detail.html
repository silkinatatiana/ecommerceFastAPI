{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <div class="chat-header-info">
        <div class="info-row">
            <span><i class="fas fa-tag"></i> Тема: {{ chat.topic or 'Без темы' }}</span>
            <span><i class="fas fa-user"></i> Пользователь:
                <a href="#" class="client-name-link" onclick="toggleClientInfo(event)">
                    {{ client.full_name or client.username or 'Клиент' }}
                </a>
            </span>
            <span><i class="fas fa-headset"></i> Оператор: {{ employee.first_name}}</span>
            <span><i class="far fa-clock"></i> Начат: {{ chat.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
        </div>
        <div class="status-badge status-{{ 'active' if is_active else 'closed' }}">
            {{ 'Активен' if is_active else 'Завершён' }}
        </div>
    </div>

    <div class="messages-area" id="messages">
        {% for msg in messages %}
        <div class="message-bubble {{ 'client-message' if msg.sender_id != employee.id else 'employee-message' }}">
            {% if msg.sender_id != employee.id %}
                <div class="sender-label">Пользователь</div>
            {% endif %}
            <div class="message-content">
                {{ msg.message }}
            </div>
            <div class="message-time">{{ msg.created_at.strftime('%d.%m.%Y %H:%M') }}</div>
        </div>
        {% endfor %}
    </div>

    <div class="chat-footer">
        {% if is_active %}
            <form method="post" action="/support/messages/{{ chat.id }}/send" class="message-form">
                <textarea name="message" rows="3" placeholder="Введите сообщение..." required></textarea>
                <div class="form-actions">
                  <button type="submit" class="btn-send">Отправить</button>
                </div>
              </form>

            <form method="post" action="/support/chats/{{ chat.id }}/complete" style="display:inline;">
                <button type="submit" class="btn-complete" style="margin-top:10px;">
                    × Завершить чат
                </button>
                </form>
        {% else %}

        {% endif %}
    </div>

    <div class="back-link-container">
        <a href="/support/chats/" class="back-link">
            ← Назад к списку чатов
        </a>
    </div>
</div>

<div id="client-info-popup" class="client-info-popup" style="display: none;">
    <div class="popup-content">
        <h4>Информация о клиенте</h4>
        <p><strong>Имя:</strong> {{ client.first_name or '—' }}</p>
        <p><strong>Фамилия:</strong> {{ client.last_name or '—' }}</p>
        <p><strong>Никнейм:</strong> @{{ client.username or '—' }}</p>
        <p><strong>Email:</strong> {{ client.email or '—' }}</p>
        <p><strong>Телефон:</strong> {{ client.phone or '—' }}</p>
        <button onclick="closeClientInfo()">Закрыть</button>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/styles/chats/chat_detail.css') }}?v=1.5">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', path='/js/chats/chat_detail.js') }}?v=1.0"></script>
{% endblock %}